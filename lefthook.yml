# Lefthook Configuration for FoodShare - Rust Edition
# Fast, intelligent git hooks powered by lefthook-rs
# Build: cd scripts/lefthook && cargo build --release

# AUTO-FIX ENABLED BY DEFAULT:
# - Prettier formats code (ts, tsx, js, jsx, json, css, md, yaml)
# - ESLint fixes linting issues
# - Import sorting (alphabetical order)
# All fixes are automatically staged!

# USAGE:
# Normal commit: git commit -m "feat: ..."  (auto-fix runs)
# Fast commit: LEFTHOOK_EXCLUDE=type-check git commit
# Skip all hooks: LEFTHOOK=0 git commit
# Quick push: SKIP_TESTS=1 SKIP_BUILD=1 git push
# Full validation: ENABLE_ALL=1 git push

# ============================================================================
# PRE-COMMIT: Fast checks with auto-fix
# ============================================================================
pre-commit:
  piped: true # Run in sequence for proper auto-fix staging
  skip:
    - merge

  commands:
    # PHASE 1: Auto-fixable checks (run first, fix, then re-stage)
    format:
      tags: format quality autofix
      glob: "*.{ts,tsx,js,jsx,json,css,scss,md,yaml,yml}"
      run: npx prettier --write --cache {staged_files}
      stage_fixed: true
      priority: 1

    lint:
      tags: lint quality autofix
      glob: "*.{ts,tsx,js,jsx}"
      run: npx eslint {staged_files} --fix --max-warnings=0 --no-warn-ignored --cache --cache-location .eslintcache
      stage_fixed: true
      priority: 1

    # PHASE 2: Security checks (after formatting)
    security-check:
      tags: security critical
      run: ./scripts/lefthook/target/release/lefthook-rs security
      priority: 2

    nextjs-security:
      tags: security critical
      glob: "*.{ts,tsx,js,jsx,json}"
      run: ./scripts/lefthook/target/release/lefthook-rs nextjs-security {staged_files}
      priority: 2

    # PHASE 3: Type checking (after lint fixes)
    type-check:
      tags: typescript
      run: npx tsc --noEmit --incremental
      priority: 3

    complexity-check:
      tags: quality optional
      glob: "*.{ts,tsx,js,jsx}"
      run: ./scripts/lefthook/target/release/lefthook-rs complexity {staged_files}
      priority: 4
      skip:
        - run: test -z "$ENABLE_COMPLEXITY" && test -z "$ENABLE_ALL"

    # Auto-sort imports (enabled by default, auto-fixes)
    sort-imports:
      tags: quality autofix
      glob: "*.{ts,tsx,js,jsx}"
      run: npx eslint {staged_files} --fix --rule 'import/order:error' --no-warn-ignored 2>/dev/null || true
      stage_fixed: true
      priority: 1

    import-check:
      tags: quality optional
      glob: "*.{ts,tsx,js,jsx}"
      run: ./scripts/lefthook/target/release/lefthook-rs import-check {staged_files}
      priority: 4
      skip:
        - run: test -z "$ENABLE_IMPORT_CHECK" && test -z "$ENABLE_ALL"

    no-console:
      tags: quality optional
      glob: "*.{ts,tsx,js,jsx}"
      run: ./scripts/lefthook/target/release/lefthook-rs no-console {staged_files}
      priority: 5
      skip:
        - run: test -z "$ENABLE_NO_CONSOLE" && test -z "$ENABLE_ALL"

    large-files:
      tags: files optional
      run: ./scripts/lefthook/target/release/lefthook-rs large-files
      priority: 5
      skip:
        - run: test -z "$ENABLE_LARGE_FILES" && test -z "$ENABLE_ALL"

    accessibility:
      tags: a11y optional
      glob: "*.{tsx,jsx}"
      run: ./scripts/lefthook/target/release/lefthook-rs accessibility {staged_files}
      priority: 5
      skip:
        - run: test -z "$ENABLE_A11Y" && test -z "$ENABLE_ALL"

# ============================================================================
# COMMIT-MSG: Validates commit message format
# ============================================================================
commit-msg:
  commands:
    conventional-commits:
      tags: commit-format
      run: ./scripts/lefthook/target/release/lefthook-rs conventional-commit {1}

# ============================================================================
# PRE-PUSH: Comprehensive checks before push
# ============================================================================
pre-push:
  parallel: false
  skip:
    - ref: wip/*

  commands:
    protected-branch:
      tags: branch critical
      run: ./scripts/lefthook/target/release/lefthook-rs protected-branch
      priority: 1

    type-check-strict:
      tags: typescript
      run: npx tsc --noEmit --strict --incremental
      priority: 2

    test:
      tags: test
      run: npm run test -- --passWithNoTests
      env:
        CI: true
      priority: 2
      skip:
        - run: test -n "$SKIP_TESTS"

    build:
      tags: build
      run: npm run build
      env:
        NODE_ENV: production
      priority: 3
      skip:
        - run: test -n "$SKIP_BUILD"

    dependency-audit:
      tags: security optional
      run: ./scripts/lefthook/target/release/lefthook-rs dependency-audit
      priority: 4
      skip:
        - run: test -z "$ENABLE_AUDIT" && test -z "$ENABLE_ALL"

    bundle-size:
      tags: performance optional
      run: ./scripts/lefthook/target/release/lefthook-rs bundle-size
      priority: 4
      skip:
        - run: test -z "$CHECK_BUNDLE_SIZE" && test -z "$ENABLE_ALL"

    test-coverage:
      tags: test optional
      run: ./scripts/lefthook/target/release/lefthook-rs test-coverage
      priority: 4
      skip:
        - run: test -z "$ENABLE_COVERAGE" && test -z "$ENABLE_ALL"

    unused-exports:
      tags: quality optional
      run: ./scripts/lefthook/target/release/lefthook-rs unused-exports
      priority: 5
      skip:
        - run: test -z "$ENABLE_DEAD_CODE" && test -z "$ENABLE_ALL"

# ============================================================================
# POST-CHECKOUT: Auto-maintenance after branch switch
# ============================================================================
post-checkout:
  commands:
    dependencies-check:
      run: |
        if [ "{1}" != "{2}" ]; then
          if git diff --name-only {1} {2} 2>/dev/null | grep -qE "^(package.json|package-lock.json)$"; then
            echo "ğŸ“¦ Dependencies may have changed, consider running npm install"
          fi
        fi

# ============================================================================
# POST-MERGE: Auto-install dependencies
# ============================================================================
post-merge:
  commands:
    dependencies-install:
      run: |
        if git diff-tree -r --name-only --no-commit-id HEAD@{1} HEAD | grep -qE "^(package.json|package-lock.json)$"; then
          echo "ğŸ“¦ Dependencies changed, running npm install..."
          npm install
        fi

# ============================================================================
# PRE-REBASE: Safety checks
# ============================================================================
pre-rebase:
  commands:
    uncommitted-changes:
      run: |
        if ! git diff --quiet || ! git diff --cached --quiet; then
          echo "âš ï¸  You have uncommitted changes - commit or stash before rebasing"
          exit 1
        fi
