# Lefthook Configuration for FoodShare - Rust Edition
# Fast, intelligent git hooks powered by lefthook-rs
# Build: cd tools && cargo build --release

# AUTO-FIX ENABLED BY DEFAULT:
# - Prettier formats code (ts, tsx, js, jsx, json, css, md, yaml)
# - ESLint fixes linting issues
# - Import sorting (alphabetical order)
# All fixes are automatically staged!

# USAGE:
# Normal commit: git commit -m "feat: ..."  (auto-fix runs)
# Fast commit: LEFTHOOK_EXCLUDE=type-check git commit
# Skip all hooks: LEFTHOOK=0 git commit
# Quick push: SKIP_TESTS=1 SKIP_BUILD=1 git push
# Full validation: ENABLE_ALL=1 git push

# ============================================================================
# PRE-COMMIT: Fast checks with auto-fix
# ============================================================================
pre-commit:
  piped: true # Run in sequence for proper auto-fix staging
  skip:
    - merge

  commands:
    # PHASE 1: Auto-fixable checks (run first, fix, then re-stage)
    format:
      tags: format quality autofix
      glob: "*.{ts,tsx,js,jsx,json,css,scss,md,yaml,yml}"
      run: bunx prettier --write --cache --cache-strategy metadata {staged_files}
      stage_fixed: true
      priority: 1
      env:
        FORCE_COLOR: "0"
        NODE_OPTIONS: ""

    lint:
      tags: lint quality autofix
      glob: "*.{ts,tsx,js,jsx}"
      run: bunx eslint {staged_files} --fix --max-warnings=0 --no-warn-ignored --cache --cache-location .eslintcache
      stage_fixed: true
      priority: 1
      env:
        FORCE_COLOR: "0"
        NODE_OPTIONS: ""

    # PHASE 2: Type checking (after lint fixes)
    type-check:
      tags: typescript
      run: bunx tsc --noEmit --incremental
      priority: 3
      env:
        NODE_OPTIONS: ""

    # Auto-sort imports (enabled by default, auto-fixes)
    sort-imports:
      tags: quality autofix
      glob: "*.{ts,tsx,js,jsx}"
      run: bunx eslint {staged_files} --fix --rule 'import/order:error' --no-warn-ignored 2>/dev/null || true
      stage_fixed: true
      priority: 1
      env:
        NODE_OPTIONS: ""

# ============================================================================
# COMMIT-MSG: Validates commit message format
# ============================================================================
commit-msg:
  commands:
    conventional-commits:
      tags: commit-format
      run: echo "Commit message validation disabled"

# ============================================================================
# PRE-PUSH: Comprehensive checks before push
# ============================================================================
pre-push:
  parallel: false
  skip:
    - ref: wip/*

  commands:
    protected-branch:
      tags: branch critical
      run: echo "Protected branch check disabled"
      priority: 1

    type-check-strict:
      tags: typescript
      run: bunx tsc --noEmit --incremental
      priority: 2
      env:
        NODE_OPTIONS: ""

# ============================================================================
# POST-CHECKOUT: Auto-maintenance after branch switch
# ============================================================================
post-checkout:
  commands:
    dependencies-check:
      run: |
        if [ "{1}" != "{2}" ]; then
          if git diff --name-only {1} {2} 2>/dev/null | grep -qE "^(package.json|bun.lock)$"; then
            echo "üì¶ Dependencies may have changed, consider running bun install"
          fi
        fi

# ============================================================================
# POST-MERGE: Auto-install dependencies
# ============================================================================
post-merge:
  commands:
    dependencies-install:
      run: |
        if git diff-tree -r --name-only --no-commit-id HEAD@{1} HEAD | grep -qE "^(package.json|bun.lock)$"; then
          echo "üì¶ Dependencies changed, running bun install..."
          bun install
        fi

# ============================================================================
# PRE-REBASE: Safety checks
# ============================================================================
pre-rebase:
  commands:
    uncommitted-changes:
      run: |
        if ! git diff --quiet || ! git diff --cached --quiet; then
          echo "‚ö†Ô∏è  You have uncommitted changes - commit or stash before rebasing"
          exit 1
        fi
